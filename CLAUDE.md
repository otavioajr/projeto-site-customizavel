# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a customizable landing page system for adventure sports professionals with a complete admin panel. The project combines static frontend with Node.js backend and Supabase for data persistence.

**Core Features:**
- Dynamic, editable landing page with admin panel
- Image upload system (LGPD compliant, stored locally in `uploads/`)
- Supabase integration for data persistence (pages, inscriptions, home content)
- Custom page creation with Canva embeds or registration forms
- Multiple inscription system with session capacity management
- PIX payment integration
- Theme customization with undo/redo

## Environments (Produção e Homologação)

This project is configured with **two separate environments**:

- **Production (main branch)**: Real environment with production Supabase database
- **Homologation (homol branch)**: Testing environment with separate Supabase database

### Environment Configuration

**Environment Variables:**
- `.env.production` - Production credentials (DO NOT COMMIT)
- `.env.homol` - Homologation credentials (DO NOT COMMIT)
- `.env.example` - Template for environment setup
- `.env` - Active environment (auto-generated by switch-env.sh)

**Important Files:**
- `switch-env.sh` - Interactive script to switch between environments
- `WORKFLOW_AMBIENTES.md` - Complete guide for working with environments

### Quick Start with Environments

```bash
# Switch to homologation (recommended for development)
./switch-env.sh homol
npm run dev:homol

# Switch to production (testing only - be careful!)
./switch-env.sh production
npm run dev:prod

# Check current environment
./switch-env.sh current
```

### Workflow Rules

⚠️ **IMPORTANT**: All changes must start in homologation (`homol` branch) and be promoted to production (`main` branch) after testing.

1. Make changes in `homol` branch
2. Test locally with homol environment (`npm run dev:homol`)
3. Create Pull Request from `homol` to `main`
4. After approval, merge to `main`
5. Production deploys automatically (Vercel) or manually (VPS)

See `WORKFLOW_AMBIENTES.md` for detailed workflow instructions.

## Architecture

### Frontend (Vanilla JS with ES6 Modules)
- **`assets/js/app.js`** - Main application logic for rendering the home page
- **`assets/js/admin.js`** - Admin panel CRUD operations and live preview
- **`assets/js/supabase.js`** - Supabase client configuration and all data operations
- **`assets/js/page.js`** - Dynamic page rendering (Canva embeds and forms)
- **`assets/js/confirmacao.js`** - Form submission confirmation logic

### Backend (Node.js + Express)
- **`server.js`** - Express server with image upload API (`/api/upload`, `/api/images`)
- **`api/config.js`** - Serverless function to serve Supabase credentials (Vercel compatible)
- **`api/index.js`** - Serverless entry point for Vercel deployment

### Data Layer (Supabase + PostgreSQL)
All data operations go through `supabase.js` which provides:
- **Pages**: `getPages()`, `savePage()`, `deletePage()`
- **Home Content**: `getHomeContent()`, `updateHomeContent()`
- **Inscriptions**: `saveInscription()`, `saveMultipleInscriptions()`, `getInscriptions()`
- **Images**: `uploadImage()`, `listImages()`, `deleteImage()` (Storage bucket)
- **Fallback**: All functions fallback to localStorage if Supabase fails

### Database Schema (Supabase)
- **`pages`** - Dynamic pages (id, slug, title, content_type, content, order, is_active)
- **`home_content`** - Single row with home page JSON (hero, about, services, gallery, theme)
- **`inscriptions`** - Form submissions with group support (id, page_slug, group_id, form_data, status)
- **`v_inscription_groups`** - View aggregating inscription groups
- **Storage bucket `images`** - For Supabase-hosted images

### Key Patterns

1. **Dual Storage Strategy**: All write operations attempt Supabase first, then fallback to localStorage
2. **Image Resolution**: `resolveImageUrl()` in app.js handles local uploads (`/uploads/`), external URLs, and data URIs
3. **Group Inscriptions**: Uses `group_id` UUID to link multiple participants, with `is_responsible` flag
4. **Session Capacity**: Before saving inscriptions, checks available slots using `_group_size` field
5. **Sequence Numbers**: Auto-incremented `_sequence` field for each inscription per page

## Common Development Commands

### Development
```bash
# Install dependencies
npm install

# Start development server (port 3001 by default)
npm start

# Development with auto-reload
npm run dev

# Fast development server (alternative)
npm run fast-dev

# Vercel dev (serverless functions locally)
npm run vercel-dev
```

### Running in Production
```bash
# No build step needed (static files)
npm run build  # Just echoes "No build needed"

# Preview production build
npm run preview
```

### Admin Access
- URL: `http://localhost:3001/admin.html` (or `/admin`)
- Default password: `admin123` (hardcoded in admin.html)

### Useful Scripts
- **`./start.sh`** - Auto-start with dependency check
- **`./iniciar-supabase.sh`** - Setup Supabase tables
- **`./start-ngrok.sh`** - Create public tunnel via ngrok

## Supabase Configuration

**CRITICAL**: Without Supabase, data only persists in localStorage and will be lost on cache clear.

### Setup Steps
1. Create project at https://supabase.com
2. Run SQL from `SETUP_TABELAS.sql` in Supabase SQL Editor
3. Create `config.js` in project root:
```javascript
window.SUPABASE_URL = 'https://your-project.supabase.co';
window.SUPABASE_ANON_KEY = 'your-anon-key';
```
4. Ensure `config.js` is in `.gitignore` (already configured)

### Migration Scripts
- **`SETUP_TABELAS.sql`** - Initial table creation
- **`MIGRATION_INSCRICAO_MULTIPLA.sql`** - Group inscriptions feature migration

## Code Organization Principles

### Working with Inscriptions
- Individual inscriptions: Use `saveInscription(pageSlug, formData, options)`
- Group inscriptions: Use `saveMultipleInscriptions(pageSlug, responsibleData, participantsData, options)`
- Always check capacity with `sessionSelections` array in options
- Group size is stored in `form_data._group_size` for capacity calculations

### Working with Images
- **Local uploads**: POST to `/api/upload` → saved in `uploads/` directory
- **Supabase Storage**: Use `uploadImage()` from supabase.js → saved in `images` bucket
- Admin uses local upload by default for LGPD compliance
- Image references can be: filename (local), URL (external), or path (Supabase)

### Adding New Fields to Forms
1. Add field definition in page's `form_config.fields` array
2. Field types: text, email, tel, textarea, select, radio, checkbox, file
3. Use `storageKey` for unique identification
4. For sessions with capacity: add `sessionCapacity` and `sessionSelections` to options

### State Management
- No React/Vue - uses vanilla JS with manual DOM updates
- Admin panel has `state` object for local state
- Preview updates happen via `postMessage` to iframe
- Undo/redo stack managed in `state.undoStack`

## Important Patterns to Follow

1. **Always import from supabase.js**: Never create new Supabase client instances
2. **Handle async errors**: All Supabase functions are async and may throw
3. **Check localStorage fallback**: When Supabase fails, localStorage is used as cache
4. **Image URL resolution**: Use `resolveImageUrl()` helper before setting src/background
5. **Form validation**: Client-side validation before submission, server validates file uploads
6. **Group operations**: When deleting/updating groups, use `deleteInscriptionGroup()` or `updateGroupStatus()`

## Testing Inscriptions Locally

To test the inscription flow:
1. Create a page in admin with type "Formulário"
2. Add form fields (nome, email, telefone minimum)
3. For sessions: add a select field with `sessionCapacity` option
4. Save and navigate to `/p/{page-slug}`
5. Submit form - check Supabase table or fallback to localStorage
6. View inscriptions in Admin → Inscrições tab

## Deployment Notes

### Vercel (Serverless)
- `vercel.json` configured for routing
- Serverless functions in `/api` directory
- Environment variables needed: `SUPABASE_URL`, `SUPABASE_ANON_KEY`
- Image uploads require Vercel Blob Storage or external service (local uploads won't persist)

### VPS/Traditional Hosting
- Use PM2 for process management: `pm2 start server.js`
- Nginx reverse proxy recommended
- Ensure `uploads/` directory has write permissions
- Set environment variables or use `config.js`

## Security Considerations

- Admin password is hardcoded - change in production
- RLS policies are permissive for MVP - restrict for production
- File upload validates MIME type and size (5MB max)
- CORS enabled - restrict origins in production
- Supabase anon key is public - rely on RLS for security
- Never commit `config.js` with credentials

## Common Issues

### "Dados não persistem"
- Check if Supabase is configured (credentials in `config.js` or env vars)
- Verify tables exist (run `SETUP_TABELAS.sql`)
- Check browser console for Supabase connection errors

### "Imagens não aparecem"
- Ensure server is running (`npm start`)
- Check if `uploads/` directory exists (auto-created on server start)
- Verify image path matches filename in uploads folder
- For Supabase Storage images, check bucket permissions

### "Session capacity not working"
- Ensure `_group_size` field exists in inscriptions
- Check `sessionSelections` array structure in form submission
- Verify session capacity logic in `saveInscription()` or `saveMultipleInscriptions()`

## File Structure

```
projeto-site-customizavel/
├── assets/
│   ├── css/styles.css          # Global styles
│   └── js/
│       ├── admin.js            # Admin panel logic
│       ├── app.js              # Home page rendering
│       ├── confirmacao.js      # Confirmation page
│       ├── page.js             # Dynamic page rendering
│       └── supabase.js         # Data layer (CRITICAL)
├── api/
│   ├── config.js               # Serverless config endpoint
│   └── index.js                # Serverless entry
├── uploads/                    # Local image storage (auto-created)
├── server.js                   # Express server (development/VPS)
├── admin.html                  # Admin panel UI
├── index.html                  # Landing page
├── confirmacao.html            # Form confirmation page
├── SETUP_TABELAS.sql           # Database schema
├── MIGRATION_INSCRICAO_MULTIPLA.sql  # Group inscriptions migration
└── config.js                   # Local Supabase credentials (gitignored)
```

## Key Functions Reference

### supabase.js exports
- `getPages()` - Get active pages for menu
- `getAllPages()` - Get all pages including inactive
- `savePage(page)` - Create or update page
- `deletePage(id)` - Delete page
- `getHomeContent()` - Get home page data
- `updateHomeContent(content)` - Save home page data
- `saveInscription(pageSlug, formData, options)` - Single inscription
- `saveMultipleInscriptions(pageSlug, responsibleData, participantsData, options)` - Group inscription
- `getInscriptions(pageSlug)` - Get all inscriptions for page
- `getInscriptionGroups(pageSlug)` - Get inscriptions grouped by group_id
- `updateInscriptionStatus(id, status)` - Update single inscription status
- `updateGroupStatus(groupId, status)` - Update all inscriptions in group
- `deleteInscription(id)` - Delete single inscription
- `deleteInscriptionGroup(groupId)` - Delete all inscriptions in group
- `uploadImage(file, folder)` - Upload to Supabase Storage
- `listImages(folder)` - List images from Storage
- `deleteImage(path)` - Delete from Storage

### Server API Endpoints
- `POST /api/upload` - Upload image to local `uploads/`
- `GET /api/images` - List local uploaded images
- `DELETE /api/images/:filename` - Delete local image
- `GET /config.js` - Serve Supabase credentials dynamically
